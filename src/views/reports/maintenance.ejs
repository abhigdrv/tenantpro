<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
    <title>Maintenance Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .filters {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filters form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.85em;
            text-transform: uppercase;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-section h3 {
            margin: 0 0 15px 0;
        }
        
        .requests-grid {
            display: grid;
            gap: 15px;
        }
        
        .request-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .request-card.high {
            border-left-color: #dc3545;
        }
        
        .request-card.medium {
            border-left-color: #ffc107;
        }
        
        .request-card.low {
            border-left-color: #28a745;
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .request-header h3 {
            margin: 0;
            color: #333;
            flex: 1;
        }
        
        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .badge.status-open {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge.status-in_progress {
            background: #cce5ff;
            color: #004085;
        }
        
        .badge.status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .badge.priority-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge.priority-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge.priority-low {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-item .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 3px;
        }
        
        .detail-item .value {
            font-weight: bold;
            color: #333;
        }
        
        .request-description {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            color: #555;
            line-height: 1.6;
        }
        
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
    </style>
</head>
<body>
    <%- include('../partials/header') %>
    <main>
        <%- include('../partials/sidebar') %>
        <section class="content">
            <div class="report-header">
                <h2>Maintenance Report</h2>
            </div>

            <!-- Filters -->
            <div class="filters">
                <form action="/agent/reports/maintenance" method="GET">
                    <div class="filter-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="">All Statuses</option>
                            <option value="open" <%= filters.status === 'open' ? 'selected' : '' %>>Open</option>
                            <option value="in_progress" <%= filters.status === 'in_progress' ? 'selected' : '' %>>In Progress</option>
                            <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Priority</label>
                        <select name="priority">
                            <option value="">All Priorities</option>
                            <option value="high" <%= filters.priority === 'high' ? 'selected' : '' %>>High</option>
                            <option value="medium" <%= filters.priority === 'medium' ? 'selected' : '' %>>Medium</option>
                            <option value="low" <%= filters.priority === 'low' ? 'selected' : '' %>>Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button type="submit" class="btn">Apply Filters</button>
                    </div>
                </form>
            </div>

            <!-- Summary Statistics -->
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>Total Requests</h4>
                    <div class="value" style="color: #007bff;"><%= summary.total %></div>
                </div>
                
                <div class="summary-card">
                    <h4>Open</h4>
                    <div class="value" style="color: #ffc107;"><%= summary.open %></div>
                </div>
                
                <div class="summary-card">
                    <h4>In Progress</h4>
                    <div class="value" style="color: #17a2b8;"><%= summary.inProgress %></div>
                </div>
                
                <div class="summary-card">
                    <h4>Completed</h4>
                    <div class="value" style="color: #28a745;"><%= summary.completed %></div>
                </div>
                
                <div class="summary-card">
                    <h4>High Priority</h4>
                    <div class="value" style="color: #dc3545;"><%= summary.high %></div>
                </div>
                
                <div class="summary-card">
                    <h4>Medium Priority</h4>
                    <div class="value" style="color: #ffc107;"><%= summary.medium %></div>
                </div>
                
                <div class="summary-card">
                    <h4>Low Priority</h4>
                    <div class="value" style="color: #28a745;"><%= summary.low %></div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-section">
                    <h3>Status Distribution</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                
                <div class="chart-section">
                    <h3>Priority Distribution</h3>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>

            <!-- Maintenance Requests -->
            <h3 style="margin-bottom: 15px;">Maintenance Requests (<%= maintenanceRequests.length %> records)</h3>
            
            <% if (maintenanceRequests.length > 0) { %>
                <div class="requests-grid">
                    <% maintenanceRequests.forEach(request => { %>
                        <div class="request-card <%= request.priority %>">
                            <div class="request-header">
                                <h3><%= request.title %></h3>
                                <div class="badges">
                                    <span class="badge status-<%= request.status.replace(' ', '_') %>">
                                        <%= request.status.toUpperCase().replace('_', ' ') %>
                                    </span>
                                    <span class="badge priority-<%= request.priority %>">
                                        <%= request.priority.toUpperCase() %> PRIORITY
                                    </span>
                                </div>
                            </div>
                            
                            <div class="request-details">
                                <div class="detail-item">
                                    <span class="label">Property</span>
                                    <span class="value"><%= request.property.name %></span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">Reported By</span>
                                    <span class="value"><%= request.tenant.firstName %> <%= request.tenant.lastName %></span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">Contact</span>
                                    <span class="value"><%= request.tenant.phone || request.tenant.email %></span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">Created</span>
                                    <span class="value"><%= request.createdAt.toLocaleDateString() %></span>
                                </div>
                            </div>
                            
                            <div class="request-description">
                                <strong>Description:</strong><br>
                                <%= request.description %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div style="background: white; padding: 40px; text-align: center; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="font-size: 3em; margin-bottom: 15px;">✓</div>
                    <h3 style="color: #28a745; margin: 0 0 10px 0;">No Requests Found</h3>
                    <p style="color: #666; margin: 0;">No maintenance requests match the selected criteria.</p>
                </div>
            <% } %>

            <div style="margin-top: 30px;">
                <a href="/agent/reports" class="btn btn-secondary">← Back to Dashboard</a>
            </div>
        </section>
    </main>
    <%- include('../partials/footer') %>

    <script>
        // Status Chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Open', 'In Progress', 'Completed'],
                datasets: [{
                    data: [<%= summary.open %>, <%= summary.inProgress %>, <%= summary.completed %>],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(23, 162, 184, 0.8)',
                        'rgba(40, 167, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 193, 7, 1)',
                        'rgba(23, 162, 184, 1)',
                        'rgba(40, 167, 69, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Priority Chart
        const priorityCtx = document.getElementById('priorityChart').getContext('2d');
        const priorityChart = new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Requests',
                    data: [<%= summary.high %>, <%= summary.medium %>, <%= summary.low %>],
                    backgroundColor: [
                        'rgba(220, 53, 69, 0.6)',
                        'rgba(255, 193, 7, 0.6)',
                        'rgba(40, 167, 69, 0.6)'
                    ],
                    borderColor: [
                        'rgba(220, 53, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(40, 167, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>